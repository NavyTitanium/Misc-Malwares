
## WordPress brute force attack
### Reconnaissance
To begin, the botnet operator uploads a list of domains to be validated by the bots. This large list contains domains that often don't even resolve or that aren't running WordPress. The bots are each fetching a JSON formatted list of 300 hosts by querying the C2 server at ```/gw?worker=wpChk```.

![Chk tasks](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/chk_n.png)

For each of the hosts provided, the bots will query for the default login page ```/wp-login.php``` and try to get the WP login username with few techniques, such as

* Looking at the posts authors ```/author/(.+?)```
* ```<span class="vcard">(.+?)</span>```
* ```/wp-json/wp/v2/users/```

Upon success, the workers reports the site as valid at the following URL : ```/project/saveGood?host=<host>&login=admin&service=wpChk```.

![Chk OK](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/chk_OK.png)

### Brute forcing

Given the working WordPress sites identified previously, the botnet operator can change the active campaign to ```wpBrt;``` and feed the bots with legitimate sites to brute force by providing a list 300 hosts at each query to ```/gw?worker=wpBrt```:

![Chk OK](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/wp_brt_n.png)

The bots will verify it the login was successfull by looking for the string ```dashicons-dashboard``` in the WordPress panel. Upon success, the workers reports to ```project/saveGood?host=<host>&login=admin&password=admin&service=wpBrt```

Here's an example of a bot trying to authenticate to **/wp-login.php** 

```
POST /wp-login.php HTTP/1.1
Host: <target>.com
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0
Content-Length: 107
Content-Type: application/x-www-form-urlencoded
Cookie: wordpress_test_cookie=WP+Cookie+check
Accept-Encoding: gzip
Connection: close

log=redirect&pwd=iranavada&wp-submit=Log In&redirect_to=http://<target>.com/wp-admin/&testcookie=1
```

Note that it uses the hard-coded user-agent ```Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0```

### Strategy

Every time a GET query is made to ```gw?worker=wpChk``` or ```gw?worker=wpBrt```, the bots are getting new content (depending on which campaign is activated at that moment). Basically, the web server itterates through its list of sites to process and assumes that if someone queried the current section of the list (300 entries per page), it's because the bot will be processing it. There's no mechanism to ensure that the bots indeed complete their task. Therefore, if we manually query those pages, they will not be served to the bots and those domains will be assumed processed. 

By using a distributed password spraying strategy, they can minimize their chances of getting their bots blocked by particular sites, while only focusing their effort on the ones that are easy to crack. While testing, one bot was able to attempt roughly 300 POST queries to sites (brute force attempt) per 10 seconds period. If we extrapolate those numbers to a day (86400 seconds), we get (300x86400/10) ~2.5 millions attempts per day, per bot.

By observing the tasks served to the bots for only one day, more than 200k websites were observed (sent to the Brute forcing workers). The list of valid WordPress sites is probably way bigger. During this same time period, the following passwords were the most frequently observed: 

* 123456
* 123456789
* password
* testtest
* test123
* test
* F*uckYou
* demo
* admin@12
* admin
* 12345678

Oftentimes, the task will specifying a variable named ```[login]``` in the password to be replaced by the login username of the WordPress site :

![Chk OK](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/login_var.png)

This way, they can try a variety of combinaison that is specific to each login usernames. Some of the most frequently seen were:

* 777[login]999
* [login]13579
* [login]@2019
* [login]@1234

Also, some of the passwords observed were very unique and not found elsewhere in common attack dictionaries on the public internet. That leads me to believe that they are using a custom made password list, probably using credentials from previous breaches/successful brute force attacks.

## PHP Backdoor

Request done by a TOR exit node
```
Accept-Encoding: gzip
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0
Content-Length: 89
Connection: close
X-Forwarded-For: 130.225.244.90
Host: <Infected site>
X-Accel-Internal: /nginx_static_files
```



## C2 used for each sample found

The binaries are configured to talk their respective C2 in order to receive tasks. The default port of the web application is 7000, however, as we can see, they are frequently changing port.

| StealthWorker Version :hammer:  | C2 address :earth_americas: | Resolves to :mag_right: |
| ------------- | ------------- | ------------- |
| 3.02 x64 | http://46.17.43.23:11679  | |
| 3.04 x64 | http://jokom.wastebincan.xyz:5487  | 209.99.40.222, previously 176.32.33.8  |
| 3.04 x32 | http://angry.wastebincan.xyz:1400 | 209.99.40.222, previously 212.60.5.130  |
| 3.09 x32 | http://marsiane.at:8349 | 87.251.70.54 |
| 3.12 x64 | http://jumanji.at:7381 | 87.251.70.26 |

| Origin AS  | Announcement | ASN Description  | Registrant Name |
| ------------- | ------------- | ------------- | ------------- |
| AS49877  | 87.251.70.0/23  | 	RMINJINERING, RU | SA Geocentru |

## C2 Panel

![Login Panel](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/LoginPage.png)

Interesting server paths & ressources
```
/static/img/
/static/js/listOfBots/console.js
/static/js/systemInfo/resourceUsage.js
/static/js/wpShell/wpShellLog.js
/login/
/login/checkUserPass
/Faq
/ajax/wpShellLog
/stats/loadLog?projectId=
/ajax/resourceUsage
/setting/checkJabberStatus
/project/receiveFile
```

The web panel seem to be quite basic, with no real secure mechanism in place. It is a simple website with a PHP authentification that isn't preventing brute force attempts. We can browse directly to most ressources (/static/ as an example) .

###

# StealthWorker ELF binaries

| Version  | SHA-256 :paw_prints: |
| ------------- | ------------- |
| 3.02 x64 | 88399850cf3a9d025fc4adb1952ee621ddb592e4cb9edf2f830a2fed4119bc2c  |
| 3.04 x64 | 22398fac9cb5a25887d20fe7a5b4ecb8f9aeacae98da4fba17e3668396aa46fa  |
| 3.04 x32 | d92587ee5e763f9d961fded9be3ba0a2fe95e311254c9d2c4135c7a1238672bf |
| 3.09 x32 | 6b463e18e01f47269d6cd7509aa6d2788cc2e7473bc9b8169bdb003f2f61c913 |
| 3.12 x64 | 7627bbcc9073c3cd930e16ca25fc215a2cc796fb68d6787d2b37fff9aa28b059 |
| 3.12 x32 | b4ed005eadb657293b83402069874bd311631ae6cddd9f6c13f4d9b8ef0c3213 |

Only version 3.12 is packed. It uses NSPack. 

When executed, the binary outputs its version (3.12) and creates a file *[stealth].pid* that contains the PID of the process created. 

![Login Panel](https://github.com/NavyTitanium/Misc-Malwares/raw/master/StealthWorker/image/cmd_Stub64.png)

A cron job is also added to run the binary every minute:
```
* * * * * /tmp/Stub_Linux_amd64.test > /dev/null 2>&1
```

## Main functions in version 3.09

Because this version is currently being distributed, I extracted the function names of this sample (3.09 x32). The binary first start 

<details>
  <summary>:small_orange_diamond:WooCommerce, HTTP GET /gw?worker=Woo</summary> 
  
 ```
StealthWorker/Worker_WooChk.init
StealthWorker/Worker_WooChk.saveGood
StealthWorker/Worker_WooChk.userEnumerate
StealthWorker/Worker_WooChk.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:wpMagOcart, HTTP GET /gw?worker=OCartBrt</summary>
  
 ```
StealthWorker/Worker_wpMagOcart.init
StealthWorker/Worker_wpMagOcart.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Admin Finder, HTTP GET /gw?worker=admfind</summary>
  
 ```
StealthWorker/WorkerAdminFinder.GetPage
StealthWorker/WorkerAdminFinder.GetPage.func1
StealthWorker/WorkerAdminFinder.init
StealthWorker/WorkerAdminFinder.SaveGood
StealthWorker/WorkerAdminFinder.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Backup finder, HTTP GET /gw?worker=backup&v=newback</summary>
  
 ```
StealthWorker/WorkerBackup_finder.HttpCheck
StealthWorker/WorkerBackup_finder.HttpCheck.func1
StealthWorker/WorkerBackup_finder.init
StealthWorker/WorkerBackup_finder.SaveGood
StealthWorker/WorkerBackup_finder.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Bitrix, HTTP GET /gw?worker=bitrixBrt&v=newback</summary>
  
 ```
StealthWorker/WorkerBitrix_brut.(*WP).HttpClient
StealthWorker/WorkerBitrix_brut.(*WP).HttpClient.func1
StealthWorker/WorkerBitrix_brut.(*WP).Init
StealthWorker/WorkerBitrix_brut.(*WP).Login
StealthWorker/WorkerBitrix_brut.init
StealthWorker/WorkerBitrix_brut.SaveGood
StealthWorker/WorkerBitrix_brut.Worker
StealthWorker/WorkerBitrix_check.init
StealthWorker/WorkerBitrix_check.saveGood
StealthWorker/WorkerBitrix_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:CPanel, HTTP GET /gw?worker=cp_b</summary>
  
 ```
StealthWorker/WorkerCpanel_brut.Brut
StealthWorker/WorkerCpanel_brut.Brut.func1
StealthWorker/WorkerCpanel_brut.Brut.func2
StealthWorker/WorkerCpanel_brut.init
StealthWorker/WorkerCpanel_brut.SaveGood
StealthWorker/WorkerCpanel_brut.Worker
StealthWorker/WorkerCpanel_check.DetectCMS
StealthWorker/WorkerCpanel_check.init
StealthWorker/WorkerCpanel_check.saveGood
StealthWorker/WorkerCpanel_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Drupal, HTTP GET /gw?worker=drupalBrt</summary>
  
 ```
StealthWorker/WorkerDrupal_brut.(*WP).HttpClient
StealthWorker/WorkerDrupal_brut.(*WP).HttpClient.func1
StealthWorker/WorkerDrupal_brut.(*WP).Init
StealthWorker/WorkerDrupal_brut.(*WP).Login
StealthWorker/WorkerDrupal_brut.init
StealthWorker/WorkerDrupal_brut.SaveGood
StealthWorker/WorkerDrupal_brut.Worker
StealthWorker/WorkerDrupal_check.init
StealthWorker/WorkerDrupal_check.saveGood
StealthWorker/WorkerDrupal_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:FTP, HTTP GET /gw?worker=ftp_b</summary>
  
 ```
StealthWorker/WorkerFTP_brut.Brut
StealthWorker/WorkerFTP_brut.CheckFalsePositive
StealthWorker/WorkerFTP_brut.init
StealthWorker/WorkerFTP_brut.SaveGood
StealthWorker/WorkerFTP_brut.Worker
StealthWorker/WorkerFTP_brut.Worker.func1
StealthWorker/WorkerFTP_check.init
StealthWorker/WorkerFTP_check.saveGood
StealthWorker/WorkerFTP_check.ScanPort
StealthWorker/WorkerFTP_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Htpasswd, HTTP GET /gw?worker=htpasswdBrt</summary>
  
 ```
StealthWorker/WorkerHtpasswd_brut.(*WP).HttpClient
StealthWorker/WorkerHtpasswd_brut.(*WP).HttpClient.func1
StealthWorker/WorkerHtpasswd_brut.init
StealthWorker/WorkerHtpasswd_brut.SaveGood
StealthWorker/WorkerHtpasswd_brut.Worker
StealthWorker/WorkerHtpasswd_check.HttpClient
StealthWorker/WorkerHtpasswd_check.HttpClient.func1
StealthWorker/WorkerHtpasswd_check.init
StealthWorker/WorkerHtpasswd_check.saveGood
StealthWorker/WorkerHtpasswd_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Joomla, HTTP GET /gw?worker=joomlaBrt</summary>
  
 ```
StealthWorker/WorkerJoomla_brut.(*WP).HttpClient
StealthWorker/WorkerJoomla_brut.(*WP).HttpClient.func1
StealthWorker/WorkerJoomla_brut.(*WP).Init
StealthWorker/WorkerJoomla_brut.(*WP).Login
StealthWorker/WorkerJoomla_brut.init
StealthWorker/WorkerJoomla_brut.SaveGood
StealthWorker/WorkerJoomla_brut.Worker
StealthWorker/WorkerJoomla_check.init
StealthWorker/WorkerJoomla_check.saveGood
StealthWorker/WorkerJoomla_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Magento, HTTP GET /gw?worker=magentoBrt</summary>
  
 ```
StealthWorker/WorkerMagento_brut.basicAuth
StealthWorker/WorkerMagento_brut.BrutDownloader
StealthWorker/WorkerMagento_brut.BrutDownloader.func1
StealthWorker/WorkerMagento_brut.BrutPanel
StealthWorker/WorkerMagento_brut.BrutPanel.func1
StealthWorker/WorkerMagento_brut.BrutRSS
StealthWorker/WorkerMagento_brut.BrutRSS.func1
StealthWorker/WorkerMagento_brut.init
StealthWorker/WorkerMagento_brut.SaveGood
StealthWorker/WorkerMagento_brut.Worker
StealthWorker/WorkerMagento_check.init
StealthWorker/WorkerMagento_check.saveGood
StealthWorker/WorkerMagento_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Mysql, HTTP GET /gw?worker=mysql_b</summary>
  
 ```
StealthWorker/WorkerMysql_brut.Brut
StealthWorker/WorkerMysql_brut.Brut.func1
StealthWorker/WorkerMysql_brut.Brut.func1.1
StealthWorker/WorkerMysql_brut.init
StealthWorker/WorkerMysql_brut.SaveGood
StealthWorker/WorkerMysql_brut.Worker
StealthWorker/WorkerMysql_brut.Worker.func1
 ```
</details>

<details>
  <summary>:small_orange_diamond:Opencart, HTTP GET /gw?worker=OCartBrt&v=newback</summary>
  
 ```
StealthWorker/WorkerOpencart_brut.(*WP).HttpClient
StealthWorker/WorkerOpencart_brut.(*WP).HttpClient.func1
StealthWorker/WorkerOpencart_brut.(*WP).Init
StealthWorker/WorkerOpencart_brut.init
StealthWorker/WorkerOpencart_brut.newfileUploadRequest
StealthWorker/WorkerOpencart_brut.SaveGood
StealthWorker/WorkerOpencart_brut.Worker
StealthWorker/WorkerOpencart_check.init
StealthWorker/WorkerOpencart_check.saveGood
StealthWorker/WorkerOpencart_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:PMA</summary>
  
 ```
StealthWorker/WorkerPMA_brut.(*Instance).CheckSuccessFull
StealthWorker/WorkerPMA_brut.(*Instance).HttpClient
StealthWorker/WorkerPMA_brut.(*Instance).HttpClient.func1
StealthWorker/WorkerPMA_brut.(*Instance).ParseForm
StealthWorker/WorkerPMA_brut.(*Instance).TryLogin
StealthWorker/WorkerPMA_brut.init
StealthWorker/WorkerPMA_brut.Instance.CheckSuccessFull
StealthWorker/WorkerPMA_brut.SaveGood
StealthWorker/WorkerPMA_brut.Worker
StealthWorker/WorkerPMA_check.DetectCMS
StealthWorker/WorkerPMA_check.init
StealthWorker/WorkerPMA_check.saveGood
StealthWorker/WorkerPMA_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:Postgres, HTTP GET /gw?worker=postgres_b</summary>
  
 ```
StealthWorker/WorkerPostgres_brut.Brut
StealthWorker/WorkerPostgres_brut.init
StealthWorker/WorkerPostgres_brut.SaveGood
StealthWorker/WorkerPostgres_brut.Worker
StealthWorker/WorkerPostgres_brut.Worker.func1
 ```
</details>

<details>
  <summary>:small_orange_diamond:Qnap, HTTP GET /gw?worker=qnapBrt</summary>
  
 ```
StealthWorker/WorkerQnap_brut.HttpClient
StealthWorker/WorkerQnap_brut.HttpClient.func1
StealthWorker/WorkerQnap_brut.init
StealthWorker/WorkerQnap_brut.newfileUploadRequest
StealthWorker/WorkerQnap_brut.SaveGood
StealthWorker/WorkerQnap_brut.Worker
StealthWorker/WorkerQnap_check.init
StealthWorker/WorkerQnap_check.saveGood
StealthWorker/WorkerQnap_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:SSH, HTTP GET /gw?worker=ssh_b</summary>
  
 ```
StealthWorker/WorkerSSH_brut.Brut
StealthWorker/WorkerSSH_brut.check_honeypot
StealthWorker/WorkerSSH_brut.Exe_cmd
StealthWorker/WorkerSSH_brut.Exe_cmd.func1
StealthWorker/WorkerSSH_brut.init
StealthWorker/WorkerSSH_brut.SaveGood
StealthWorker/WorkerSSH_brut.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:WHM, HTTP GET /gw?worker=whm_b</summary>
  
 ```
StealthWorker/WorkerWHM_brut.Brut
StealthWorker/WorkerWHM_brut.Brut.func2
StealthWorker/WorkerWHM_brut.Brut.func3
StealthWorker/WorkerWHM_brut.init
StealthWorker/WorkerWHM_brut.SaveGood
StealthWorker/WorkerWHM_brut.Worker
StealthWorker/WorkerWHM_check.DetectCMS
StealthWorker/WorkerWHM_check.init
StealthWorker/WorkerWHM_check.saveGood
StealthWorker/WorkerWHM_check.Worker
 ```
</details>

<details>
  <summary>:small_orange_diamond:WordPress, HTTP GET /gw?worker=wpBrt</summary>
  
 ```
StealthWorker/Worker_WpInstall_finder.init
StealthWorker/Worker_WpInstall_finder.Init
StealthWorker/Worker_WpInstall_finder.saveGood
StealthWorker/Worker_WpInstall_finder.Worker
StealthWorker/WorkerWP_brut.(*WP).brutXmlRpc
StealthWorker/WorkerWP_brut.(*WP).HttpClient
StealthWorker/WorkerWP_brut.(*WP).HttpClient.func1
StealthWorker/WorkerWP_brut.(*WP).Init
StealthWorker/WorkerWP_brut.(*WP).Login
StealthWorker/WorkerWP_brut.checkBrutOk
StealthWorker/WorkerWP_brut.checkMustAddWWW
StealthWorker/WorkerWP_brut.checkMustSwitchScheme
StealthWorker/WorkerWP_brut.init
StealthWorker/WorkerWP_brut.SaveGood
StealthWorker/WorkerWP_brut.Worker
StealthWorker/WorkerWP_check.init
StealthWorker/WorkerWP_check.saveGood
StealthWorker/WorkerWP_check.userEnumerate
StealthWorker/WorkerWP_check.Worker
```
</details>


## IoCs
