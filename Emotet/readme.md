On infected WordPress sites, the following files are always present:
```
#ls -la /home/<web user>/public_html/<website>/<infected directory>
drwxr-xr-x 2 <web user> <web user>   4096 Oct 16 03:42 .
drwxr-xr-x 4 <web user> <web user>   4096 Oct 16 16:26 ..
-rw-r--r-- 1 <web user> <web user>      7 Oct 16 16:42 .2d52cebe504208dd775597d6411eaf21af00f04b
-rw-r--r-- 1 <web user> <web user>     95 Oct 16 16:43 .htaccess
-rw-r--r-- 1 <web user> <web user> 204144 Oct 16 16:43 index.php
```
In this example, if the name of the infected directory is **v4A1d**, a file named **.2d52cebe504208dd775597d6411eaf21af00f04b** will be created (sha1(basename($contentPath))). 

The **index.php** contains the payload that will be sent to the client after ***gzinflate(base64_decode())***

**import.php** is the backdoor found one directory up the infected path (the name of the WebShell varies). It is use to receive commands type 1 and 2 via POST requests. They're using the popular [WSO webshell](https://github.com/tennc/webshell/blob/master/php/wso/wso2.php). The password for this version is set to ***2cb00388f2110209ccb15e8ec3ab5835***

![](hello_bonjur-WSO.png)

October 2019: They slightly modified the WSO WebShell and changed the password. See file **user.php** . Other file names seen includes: **link.php**, **update.php**, **menu.php**, **config.php**. They will usually leave more then 1 of them behind, in different directories, in case one gets deleted. I created a simple Python script to itterate on some paths on a Wordpress site. It looks for those backdoors. See **emotet_webshell_finder.py** 

Sometime, they will also modify the timestamp of the file, so it appears to have been created at a different date (e.g. 01-Jan-1970).

I was able to find most backdoors using those grep searches:
```
grep -lr --include=*.php "]) { exit(" /var/www/html/
grep -lr --include=*.php "php goto " /var/www/html/
grep -lr --include=*.php "*/ ?><?php function " /var/www/html/
grep -lr --include=*.php "Rst { const" /var/www/html/
```
## dir.zip

Zip archive left behind by the actor. It contains PHP code with Russian comments. We can learn that the Webshell is being fetch from:

- https://pastebin.com/raw/hpqEekGT (has been seen 1289 times as of November 18th, 2019)
- https://pastebin.com/raw/kHL0XPea (has been seen 890 times as of November 18th, 2019)
- https://pastebin.com/raw/9yWezgqx (has been seen 270 times as of November 18th, 2019)


## Command type 1
Is running every ~4 mins. Returns the content of the file ***sha1(basename($contentPath))*** encoded in base64. Example:
Content of the file:
```
{"0":1294,"4":822,"2":78,"3":35,"1":18}
```
Those values represents the counts on the victims per platform (by looking at the user agent of the requestors):

| const PLATFORM | Value |
| ------------- |-------------:|
| UNKNOWN | 0 |
| ANDROID | 1 |
| APPLE | 2 |
| LINUX | 3 |
| WINDOWS | 4 |

Returned string:
```
[RST]eyIwIjoxMjk0LCI0Ijo4MjIsIjIiOjc4LCIzIjozNSwiMSI6MTh9[/RST]
```
## Command type 2
Is running every ~5 mins. Updates the ***.htaccess*** and the ***index.php*** files that contains the payload. Returns the status of the operation in base64. Example:
```
[RST]eyJzdGF0dXMiOi0xfQ==[/RST]
```
Because the WebShell run the commands being send right away, they don't have to let any IPs related to the actual C2 in a file on disk.

## Who's sending those POST queries ?
I think the clients issuing POST queries to infected WordPress are also infected. Anyways, here are the IPs observed (on ***many*** occasions):

| IP address | AS | Provider | Country | Reverse hostname | Website | Service | OSINT |
| ------------- |-------------|-------------|-------------|-------------|-------------|-------------|-------------:|
| 5.39.91.110 | 16276 | OVH | France | ns3278366.ip-5-39-91.eu. | www.twsoft.co.uk | Apache/2.4.6 (CentOS) | Known Dridex C2 |
| 83.172.132.27 | 25459 | NedZone Internet BV | Netherlands | ns1.chamassa.com. | www.kevinsijbers.com | Apache/2.2.15 (CentOS) |
| 178.128.33.106 | 14061 | Digital Ocean | UK | | www.infinitybusinessgrowthnetwork.co.uk | Apache/2.4.18 (Ubuntu) |
| 173.249.16.143 | 51167 | Contabo GmbH | Germany | zeus.dertipi.de. | | Apache/2.4.25 (Debian) |
| 128.199.247.176 | 14061 | Digital Ocean  | Singapore |  | www.comquas.com | nginx/1.14.0 (Ubuntu) |
| 37.187.20.215 | 16276 | OVH | France | ks3354848.kimsufi.com. | bloomfromthedarkness.com | Apache/2.4.6 (CentOS) |
| 142.93.204.172 | 14061 | Digital Ocean  | US | steelquimica.com.br. | | |
| 162.243.158.154 | 14061 | Digital Ocean  | US | silvercitrus.com. | | Apache/2.4.7 (Ubuntu) |
| 212.68.198.234 | 12392 | Brutele SC | Belgium | host-212-68-198-234.dynamic.voo.be. | | Apache/2.4.38 (Debian) | Known Dridex C2 |
| 212.83.36.6 | 47447 | 23media GmbH | Germany |  | | nginx/1.17.5 |  |
| 178.32.255.135 | 16276 | OVH | France | | | Apache/2.4.7) |  |
| 138.197.111.1 | 14061 | Digital Ocean | US |  | | nginx/1.14.0 |  |
| 69.16.193.166 | 32244 | Liquid Web | US |  | | Apache/2.4.7 |  |
| 37.187.54.76 | | | |  | | |  |
| 170.150.11.242 | 264712 | MONICA E. SEÑORANS | Argentina |  | | |  |
| 95.217.3.174 | 24940 | Hetzner Online GmbH | Finland |  | | |  |
| 69.161.223.175 | 19871 | Network Solutions | US |  | | |  |
| 121.79.197.229 | 17705 | InSPire Net | New Zealand |  | | |  |
| 64.22.124.239 | 63949 | Linode | US |  | | |  |

All POST queries seen had this user agent set: **Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0**.

The header of the requests also contains **X-HTTPS : 1**, which makes me believe that the requesting hosts are only serving as proxies.

```
User-Agent : Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0
Host : <infected site>
Accept : */*
Referer : https://<infected site>/<path to the webshell>.php
Cookie : <omitted>=<omitted>
Content-Length : 952
Content-Type : application/x-www-form-urlencoded
X-HTTPS : 1
```
