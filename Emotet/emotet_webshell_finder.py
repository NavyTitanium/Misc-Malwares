from urllib.request import urlopen, Request
from urllib.parse import urlparse

filename = "list.txt"
TIMEOUT = 8
UA = 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:64.0) Gecko/20100101 Firefox/64.0'
OK_status = ['2', '4', '5']
WP_paths = ['/wp-content', '/wp-includes', '/wp-admin', '/', '/wp-includes/fonts', '/wp-includes/js', '/wp-content/plugins',
            '/wp-includes/customize', '/wp-admin/css', '/wp-admin/css/colors', '/wp-content/uploads']
Webshells = [
    'user.php',
    'common.php',
    'import.php',
    'update.php',
    'link.php',
    'menu.php',
    'image.php',
    'tools.php',
    'core.php',
    'edit.php',
    'functions.php',
    'config.php']

def process_reply(reply, website):
    if "<form method=post>Password" in reply:
        print("[Webshell found] " + website)

def crawl(website, paths, webshell):
    website = website + paths + "/" + webshell
    request = Request(website, headers={'User-Agent': UA})

    try:
        response = urlopen(request, timeout=TIMEOUT)
        process_reply(response.read().decode("utf8"), website)
    except Exception as e:
        pass
#        print("[Status] ", e)

def validate_connection(website):
    try:
        urlopen(Request(url, headers={'User-Agent': UA}), timeout=TIMEOUT)
        return True
    except Exception as e:
        if("timed" in str(e)):
            print("[Website timed out, abording] ", website)
            return False

def parse_url(url):
    url = url.replace("hxxp://", "http://")
    url = url.replace("hxxps://", "https://")
    o = urlparse(url)
    url_without_query_string = o.scheme + "://" + o.netloc
    url_without_query_string = url_without_query_string.rstrip("/")
    return url_without_query_string

def main_loop(url):
    if(validate_connection(url)):
        for paths in WP_paths:
            for webshell in Webshells:
                crawl(url, paths, webshell)

with open(filename) as f:
    for line in f:
        url = parse_url(line.strip())
        main_loop(url)
